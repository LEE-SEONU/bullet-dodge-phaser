<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Bullet Dodge ğŸš€</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.11.1/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { display: block; margin: 0 auto; box-shadow: 0 0 20px rgba(0,255,255,0.3); }
    </style>
</head>
<body>
    <script type="text/javascript">
        var game = new Phaser.Game(400, 600, Phaser.AUTO, '');

        // --- Menu State ---
        var MenuState = {
            preload: function() {
                var ts = new Date().getTime();
                game.load.image('splash', 'assets/splash.png?v=' + ts);
            },
            create: function() {
                var splash = game.add.sprite(0, 0, 'splash');
                splash.width = 400;
                splash.height = 600;
                game.input.onDown.addOnce(function() { game.state.start('play'); }, this);
            }
        };

        // --- Play State ---
        var PlayState = {
            preload: function() {
                var ts = new Date().getTime();
                game.load.image('player', 'assets/player.png?v=' + ts);
                game.load.image('bullet', 'assets/bullet.png?v=' + ts);
                game.load.image('space', 'assets/space.png?v=' + ts);
            },

            create: function() {
                // ìš°ì£¼ ë°°ê²½
                this.space = game.add.tileSprite(0, 0, 400, 600, 'space');
                
                game.physics.startSystem(Phaser.Physics.ARCADE);

                // í”Œë ˆì´ì–´ ì„¤ì •
                this.player = game.add.sprite(game.world.centerX, game.world.centerY, 'player');
                this.player.anchor.setTo(0.5, 0.5);
                game.physics.arcade.enable(this.player);
                this.player.body.collideWorldBounds = true;

                // ì´ì•Œ ê·¸ë£¹
                this.bullets = game.add.group();
                this.bullets.enableBody = true;

                // ì¡°ì‘ ì„¤ì • (WASD)
                this.cursors = game.input.keyboard.createCursorKeys();
                this.wasd = {
                    up: game.input.keyboard.addKey(Phaser.Keyboard.W),
                    down: game.input.keyboard.addKey(Phaser.Keyboard.S),
                    left: game.input.keyboard.addKey(Phaser.Keyboard.A),
                    right: game.input.keyboard.addKey(Phaser.Keyboard.D)
                };

                // ë“œë˜ê·¸ ì¡°ì‘ ê´€ë ¨
                this.isDragging = false;
                game.input.onDown.add(this.onStartDrag, this);
                game.input.onUp.add(this.onStopDrag, this);

                // íƒ€ì´ë¨¸ (ì´ì•Œ ìƒì„± ë° ì ìˆ˜)
                this.bulletTimer = game.time.events.loop(200, this.spawnBullet, this);
                this.startTime = game.time.now;
                
                this.scoreLabel = game.add.text(20, 20, "Time: 0s", { font: "24px Arial", fill: "#00ffff" });
                this.isGameOver = false;
            },

            onStartDrag: function() { this.isDragging = true; },
            onStopDrag: function() { this.isDragging = false; },

            update: function() {
                if (this.isGameOver) return;

                // 1. í‚¤ë³´ë“œ ì¡°ì‘ (WASD)
                var speed = 300;
                this.player.body.velocity.x = 0;
                this.player.body.velocity.y = 0;

                if (this.wasd.left.isDown || this.cursors.left.isDown) this.player.body.velocity.x = -speed;
                else if (this.wasd.right.isDown || this.cursors.right.isDown) this.player.body.velocity.x = speed;

                if (this.wasd.up.isDown || this.cursors.up.isDown) this.player.body.velocity.y = -speed;
                else if (this.wasd.down.isDown || this.cursors.down.isDown) this.player.body.velocity.y = speed;

                // 2. í„°ì¹˜ ë“œë˜ê·¸ ì¡°ì‘
                if (this.isDragging) {
                    // ì†ê°€ë½ ìœ„ì¹˜ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™
                    game.physics.arcade.moveToPointer(this.player, speed * 1.5);
                    // ëª©í‘œ ìœ„ì¹˜ ê·¼ì²˜ë©´ ë©ˆì¶¤ (ë–¨ë¦¼ ë°©ì§€)
                    if (Phaser.Rectangle.contains(this.player.body, game.input.x, game.input.y)) {
                        this.player.body.velocity.setTo(0, 0);
                    }
                }

                // ì¶©ëŒ ì²´í¬
                game.physics.arcade.overlap(this.player, this.bullets, this.die, null, this);

                // ì ìˆ˜ ì—…ë°ì´íŠ¸
                var elapsed = Math.floor((game.time.now - this.startTime) / 1000);
                this.scoreLabel.text = "Time: " + elapsed + "s";
                
                // ë°°ê²½ ìŠ¤í¬ë¡¤
                this.space.tilePosition.y += 1;
            },

            spawnBullet: function() {
                if (this.isGameOver) return;

                // ì‚¬ë°©(ìƒ, í•˜, ì¢Œ, ìš°) ì¤‘ í•œ ê³³ì—ì„œ ìƒì„±
                var side = Math.floor(Math.random() * 4);
                var x, y, vx, vy;
                var bulletSpeed = 150 + (Math.random() * 100);

                if (side === 0) { // Top
                    x = Math.random() * 400; y = -20;
                    vx = (Math.random() - 0.5) * 100; vy = bulletSpeed;
                } else if (side === 1) { // Bottom
                    x = Math.random() * 400; y = 620;
                    vx = (Math.random() - 0.5) * 100; vy = -bulletSpeed;
                } else if (side === 2) { // Left
                    x = -20; y = Math.random() * 600;
                    vx = bulletSpeed; vy = (Math.random() - 0.5) * 100;
                } else { // Right
                    x = 420; y = Math.random() * 600;
                    vx = -bulletSpeed; vy = (Math.random() - 0.5) * 100;
                }

                var bullet = this.bullets.create(x, y, 'bullet');
                bullet.anchor.setTo(0.5, 0.5);
                bullet.body.velocity.setTo(vx, vy);
                bullet.checkWorldBounds = true;
                bullet.outOfBoundsKill = true;
            },

            die: function() {
                if (this.isGameOver) return;
                this.isGameOver = true;
                game.time.events.remove(this.bulletTimer);
                this.bullets.setAll('body.velocity.x', 0);
                this.bullets.setAll('body.velocity.y', 0);

                var finalTime = Math.floor((game.time.now - this.startTime) / 1000);
                var style = { font: "40px Arial", fill: "#ff0000", align: "center", fontWeight: "bold" };
                var text = game.add.text(game.world.centerX, game.world.centerY, "GAME OVER\n" + finalTime + "s survived\nTap to Restart", style);
                text.anchor.setTo(0.5, 0.5);
                
                game.time.events.add(1000, function() {
                    game.input.onDown.addOnce(function() { game.state.start('menu'); }, this);
                }, this);
            }
        };

        game.state.add('menu', MenuState);
        game.state.add('play', PlayState);
        game.state.start('menu');
    </script>
</body>
</html>
