<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Bullet Dodge ðŸš€</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.11.1/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        canvas { display: block; margin: 0 auto; box-shadow: 0 0 20px rgba(0,255,255,0.3); }
    </style>
</head>
<body>
    <script type="text/javascript">
        var game = new Phaser.Game(400, 600, Phaser.AUTO, '');

        // --- Menu State ---
        var MenuState = {
            preload: function() {
                var ts = new Date().getTime();
                game.load.image('splash', 'assets/splash.png?v=' + ts);
            },
            create: function() {
                var splash = game.add.sprite(0, 0, 'splash');
                splash.width = 400;
                splash.height = 600;
                game.input.onDown.addOnce(function() { game.state.start('play'); }, this);
            }
        };

        // --- Play State ---
        var PlayState = {
            preload: function() {
                var ts = new Date().getTime();
                game.load.image('player', 'assets/player.png?v=' + ts);
                game.load.image('bullet', 'assets/bullet.png?v=' + ts);
                game.load.image('space', 'assets/space.png?v=' + ts);
            },

            create: function() {
                this.isGameOver = false;
                this.startTime = game.time.now;

                // ë°°ê²½
                this.space = game.add.tileSprite(0, 0, 400, 600, 'space');
                
                game.physics.startSystem(Phaser.Physics.ARCADE);

                // í”Œë ˆì´ì–´
                this.player = game.add.sprite(game.world.centerX, game.world.centerY, 'player');
                this.player.anchor.setTo(0.5, 0.5);
                game.physics.arcade.enable(this.player);
                this.player.body.collideWorldBounds = true;
                this.player.body.setSize(20, 20, 15, 15);

                // ì´ì•Œ ê·¸ë£¹
                this.bullets = game.add.group();
                this.bullets.enableBody = true;
                this.bullets.physicsBodyType = Phaser.Physics.ARCADE;

                // ì¡°ìž‘
                this.cursors = game.input.keyboard.createCursorKeys();
                this.wasd = {
                    up: game.input.keyboard.addKey(Phaser.Keyboard.W),
                    down: game.input.keyboard.addKey(Phaser.Keyboard.S),
                    left: game.input.keyboard.addKey(Phaser.Keyboard.A),
                    right: game.input.keyboard.addKey(Phaser.Keyboard.D)
                };

                this.isDragging = false;
                game.input.onDown.add(function() { this.isDragging = true; }, this);
                game.input.onUp.add(function() { this.isDragging = false; }, this);

                // UI
                this.scoreLabel = game.add.text(20, 20, "Ready...", { font: "24px Arial", fill: "#00ffff" });
                this.debugLabel = game.add.text(20, 50, "", { font: "14px Arial", fill: "#ffffff" });

                // ì‹œìž‘ ì§€ì—°
                game.time.events.add(2000, this.startSpawning, this);
            },

            startSpawning: function() {
                if (this.isGameOver) return;
                game.time.events.loop(100, this.spawnBullet, this);
                this.scoreLabel.text = "Time: 0s";
            },

            update: function() {
                if (this.isGameOver) return;

                var speed = 250;
                this.player.body.velocity.setTo(0, 0);

                if (this.wasd.left.isDown || this.cursors.left.isDown) this.player.body.velocity.x = -speed;
                else if (this.wasd.right.isDown || this.cursors.right.isDown) this.player.body.velocity.x = speed;

                if (this.wasd.up.isDown || this.cursors.up.isDown) this.player.body.velocity.y = -speed;
                else if (this.wasd.down.isDown || this.cursors.down.isDown) this.player.body.velocity.y = speed;

                if (this.isDragging) {
                    game.physics.arcade.moveToPointer(this.player, speed * 1.5);
                }

                // íšŒì „ ë¡œì§: ì†ë„ê°€ ìžˆì„ ë•Œë§Œ í•´ë‹¹ ë°©í–¥ìœ¼ë¡œ íšŒì „
                if (this.player.body.velocity.x !== 0 || this.player.body.velocity.y !== 0) {
                    // ë°©í–¥ì´ ë°˜ëŒ€ë¼ëŠ” ìš”ì²­ì— ë”°ë¼ 180ë„(Math.PI)ë¥¼ ë”í•´ ë°©í–¥ì„ ë°˜ì „ì‹œí‚´
                    this.player.rotation = Math.atan2(this.player.body.velocity.y, this.player.body.velocity.x) + Math.PI;
                }

                // ì¶©ëŒ ì²´í¬
                game.physics.arcade.overlap(this.player, this.bullets, this.die, null, this);

                // ì ìˆ˜ ë° ë””ë²„ê·¸
                var elapsed = Math.floor((game.time.now - (this.startTime + 2000)) / 1000);
                if (elapsed >= 0) {
                    this.scoreLabel.text = "Time: " + elapsed + "s";
                    this.debugLabel.text = "Bullets: " + this.bullets.countLiving();
                }
                
                this.space.tilePosition.y += 0.5;
            },

            spawnBullet: function() {
                if (this.isGameOver) return;

                var side = game.rnd.integerInRange(0, 3);
                var x, y, vx, vy;
                var speed = game.rnd.integerInRange(100, 200);

                if (side === 0) { x = game.rnd.integerInRange(0, 400); y = -10; vx = game.rnd.integerInRange(-50, 50); vy = speed; }
                else if (side === 1) { x = game.rnd.integerInRange(0, 400); y = 610; vx = game.rnd.integerInRange(-50, 50); vy = -speed; }
                else if (side === 2) { x = -10; y = game.rnd.integerInRange(0, 600); vx = speed; vy = game.rnd.integerInRange(-50, 50); }
                else { x = 410; y = game.rnd.integerInRange(0, 600); vx = -speed; vy = game.rnd.integerInRange(-50, 50); }

                var bullet = this.bullets.getFirstExists(false);
                if (!bullet) {
                    bullet = this.bullets.create(x, y, 'bullet');
                } else {
                    bullet.reset(x, y);
                }

                bullet.anchor.setTo(0.5, 0.5);
                bullet.body.velocity.setTo(vx, vy);
                bullet.checkWorldBounds = false;
                bullet.outOfBoundsKill = false;
            },

            die: function() {
                if (this.isGameOver) return;
                this.isGameOver = true;
                this.player.alive = false;
                this.bullets.setAll('body.velocity.x', 0);
                this.bullets.setAll('body.velocity.y', 0);

                var style = { font: "40px Arial", fill: "#ff0000", align: "center", fontWeight: "bold" };
                var text = game.add.text(game.world.centerX, game.world.centerY, "GAME OVER\nTap to Restart", style);
                text.anchor.setTo(0.5, 0.5);
                
                game.time.events.add(1000, function() {
                    game.input.onDown.addOnce(function() { game.state.start('menu'); }, this);
                }, this);
            }
        };

        game.state.add('menu', MenuState);
        game.state.add('play', PlayState);
        game.state.start('menu');
    </script>
</body>
</html>
